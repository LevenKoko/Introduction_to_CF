# 3. 推荐算法

该平台采用的推荐算法先根据目标重要性进行排序，选出其中较为重要的目标作为候选目标集，接着在候选目标集中按照目标的匹配度和相应规则不停地进行筛选，直至选出最优目标，即最终推荐集。我们将对目标的需求匹配分为两种：硬匹配与软匹配。硬匹配对应对目标较强的属性限制，如车辆类型、载重、车辆体积等；而软匹配对目标的属性制约并不强烈，但是对于决策有很好的辅助作用。由于算法难以直接对零散数据进行有效应用，我们从物流运输中抽象出了基础条件、线路选择、合作关系、隐性资源四个数学模型，并将数据结构化后再用算法进行推荐。*

### 3.1 模型构建

##### 3.1.1 基础条件模型

我们发现，运输车辆类型（卡车、面包车、电动车等）、车辆载重、车辆尺寸（长度、限高、体积）等基础条件对推荐范围有着直接的影响，属于硬性制约条件。此外，某些大型车对只能运输特定的货物，某些货物只能由特定的大型车运输。因此，将这些硬性条件抽象出一个基础条件模型，为进一步的硬匹配处理出结构化的数据。

该模型中的数据主要有车辆基本信息（车牌、类型、载重、尺寸、特定运输限制）、车辆司机基本信息（姓名、电话、驾龄、驾驶里程）、司机的运输偏好（长途/短途）等。

该模型处理数据的基本步骤如下：

第一步 进行数据清洗工作。如果出现同一辆车拥有多个id、车辆尺寸与类型不一致、联系人有多个等情况，则该车不可用，将此类无效数据清除。

第二步 对车辆基本信息进行去重处理。经过第一步清洗后，每辆车只对应一个车辆id，随即以注册时间距现在时间最近的车辆为基准，对每一个id的车辆基本信息进行去重处理。

第三步 对车辆类型进行校验处理。以该车在平台上最近的成交记录为基准，更新车辆的类型信息，对历史登记信息进行校验。新注册的车辆则需要上传机动车行驶证和机动车驾驶证信息，以便准确采集车辆类型信息。

第四步 对车辆司机的电话进行校验处理，以最近成交记录中的电话为基准，对所有车辆司机电话信息进行校验，以获得准确的联系人信息。

第五步 对平台上所有的车辆基本信息进行画像处理，并将全部车辆信息按结构体形式存储到车辆数据库中，方便推荐算法调用。

第六步 当收到推荐请求时，根据车辆需求信息进行筛选，去掉基础条件不符合的车辆，形成推荐车辆的候选集，并进行进一步筛选以形成最终的推荐范围。

##### 3.1.2 线路选择模型

除了上述提到的基础硬性条件，现实中还存在许多软性条件限制。中长途运输不同于短途运输，常进行中长途运输的司机倾向于相对固定的货源和较为熟悉的路线，他们熟悉沿途高速收费情况、道路拥挤程度等，对目的地城市往往也比较熟悉。选择这些路线可以帮助司机准时安全地将货物送达。因此我们抽象出一个线路选择模型，帮助推荐算法根据不同的订单需求进行更加精准高效的推荐，提高推荐成功率。

该模型中的数据主要有车辆进行长途/短途运输的次数、车辆启发点、车辆终达点、订单沿途途径点位等。

该模型处理数据的基本步骤如下：

第一步 对车辆历史订单进行分析。由此初步确定车辆的偏好，如司机习惯于长途还是短途运输、经常途径哪些城市、常跑路线等。

第二步 对运输路线进行画像处理。以历史运单中的启发地和终达地为基础，统计出该车辆经常运输路线，并记录下对应的运输次数。

第三步 对途径城市进行画像处理。统计出历史订单中的启发地和终达地，并记录下城市被途径的次数。

第四步 建立城市之间的相似度地图。对每个城市和其周围一定范围内的城市建立相似关系，距离越近则相似度越高。之后进行线路匹配可以利用相似度排序进行更有效更准确的推荐。

第五步 对经基础条件模型筛选后得到的候选集中的车辆进行线路选择，根据订单需求的启发地和终达地进行匹配计算，若车辆的熟悉路线和这两个地点进行相似度匹配计算的值较高，则提高该车辆的推荐分值，最后根据分值进行综合排序，得到最适合的推荐集合。

##### 3.1.3 合作关系模型

有些司机不一定具有相对固定的运输路线，而是拥有相对固定的货源地与合作厂商，并且和这些厂商或仓库有较高的熟悉与信任度。几乎每个厂商都有一批经常合作的运输司机，每个司机手中也常有经常联系的仓库与货源地。因此，我们抽象出一个合作关系模型，将订单推荐给与需求方有较强合作关系的司机，由此提高推荐的成功率。

该模型中的数据主要有司机id、货主id、合作次数、货源地地点等。

该模型处理数据的基本步骤如下：

第一步 基于历史订单，对所有货主（货源地）按司机id进行合作次数统计，并映射为合作关系强度。对于超过3个月的历史合作记录，降低其权重再进行统计。建立以货主为中心结点、司机为子结点的辐状图，边权重即为经加权计算后的有效合作次数。

第二步 根据订单需求的启发地和终达地，结合城市相似度地图，根据相似度和合作关系强度两个指标对各司机进行评分，城市相似度越高、合作关系越强，则评分越高。在合作关系足够强的情况下，允许存在启发地或终达地周边城市货源的合作司机评分高于本地货源的合作司机评分，由此可计算出更符合实际的结果。

第三步 对启发地和终达地及其周边货源地的合作司机按分值排序，对各序列中的司机进行综合总排序，选取分值高且与两地均有较强相关性的司机放入推荐集合。

##### 3.1.4 隐性资源模型

我们发现，仅仅以车辆与启发地的距离进行推荐存在其片面性。因为车辆的行驶方向并不确定，对一个距离货源地很近但正在远离货源地的车辆进行推荐显然是不合理的。事实上，司机们常常在还未到终达地的时候就开始联系当地货源，因此对正在靠近货源地的车辆进行推荐有较高的成功率。同时，在货源地或其附近静止的车辆被推荐成功的机率也比较大。由此抽象出一个隐性资源模型。

该模型中的数据主要有车辆不同时刻的位置信息、车辆id。

该模型处理数据的基本步骤如下：

第一步 判断车辆位置。根据以生成的候选集中的车辆id去获取其位置，判断车辆是否在启发地周围，如果否则筛出候选集。

第二步 获取启发地周围未被占用车辆的id和位置，将其加入候选集。

第三步 对候选集中的车辆每隔10分钟记录一次位置信息，连续记录2小时。

第四步 根据记录下的2小时位置信息判断车辆是否为静止车辆，若静止则将其加入新的候选集。

第五步 对候选集中的非静止车辆进行筛选。对于每个车辆，利用余弦相似度算法判断其运动趋势。若车辆有靠近启发地的趋势，将该车辆放入新的候选集。

### 3.2 算法分析

##### 3.2.1 余弦相似度算法

首先介绍用于进行相似度计算的余弦相似度算法。该算法以向量空间中两个向量夹角的余弦值作为衡量两个个体间差异大小的度量。余弦值越接近1，就说明两向量夹角越接近于0°，则可认为两个向量越相似，这就叫余弦相似性。

该算法主要在建立城市相似度地图和判断车辆行驶趋势中应用，下面讲分别进行阐释。

在建立城市相似度地图的过程中，先计算出城市间的距离图，边权即为两城市间的距离。接着对所有城市按如下步骤处理：

第一步 让所选城市的每一个周边城市对应一个n维向量。以所选城市为中心城市，以i公里为直径画圆，若某周边城市在圆外（即边权大于i/2公里），则将其向量的第一个坐标赋值为0；否则赋值为1。

第二步 每次将直径提升i公里，继续以中心城市为圆心画圆，若某城市在第k次画圆时位于圆外，则将其向量的第k个坐标赋值为0；否则赋值为1。如此反复直至直径达到r公里(r≤300)。

第三步 得到所有周边城市的n维向量，计算其与n维向量（1,1,...,1）的余弦。由向量构建过程可知，周边城市与中心城市越接近，其余弦值越接近1，余弦相似度越高。

第四步 对所有登记城市进行余弦相似度计算，建立城市相似度地图。由于对称性，两城市之间的余弦相似度仅需要计算1次。

在判断车辆行驶趋势的过程中，对候选集中的非静止车辆进行筛选的步骤如下：

对于每个车辆的一系列经纬度坐标，做线性回归拟合出一条直线和该直线指向启发地的方向向量a，再取从车辆第一次记录位置到启发地的方向向量b，对两向量进行余弦相似度计算，如果相似度大于设定值，则可判断车辆具有向启发地靠近的趋势。

##### 3.2.2 整体算法流程

[1] 推荐数据初始化。将订单中对车辆的要求、启发地、终达地、货源等信息提取出来。

[2] 检索货源地及其周边可用车辆，将其加入候选集中。

[3] 将[2]中候选集的车辆用基础条件模型进行计算，筛去不符合硬性条件的车辆。

[4] 利用隐性资源模型，将靠近趋势不是货源地的车辆筛去。

[5] 利用合作关系模型，在现有候选集中按照与货源地的合作关系强度进行降序排序，并赋予相应分值。

[6] 利用线路选择模型，将车辆历史订单的运输路线画像与订单路线进行相似性比较，按照匹配程度赋予相应分值。

[7] 对经过模型计算后的车辆数据进行加权计算，得出最终分值，按降序排序，选取排名靠前的车辆作为最终推荐集。

[8] 将推荐集中的车辆基本信息返回给用户



参考文献：*基于区块链的智能物流数据分析平台研究与实现_任超